var Oauth2=function(){function e(e){if(window.self===window.top){if(this.opts=this.defaults(e),e.cookieName&&""!==e.cookieName){var t=this.getCookie(e.cookieName);t&&"false"!==t||sessionStorage.removeItem("oauth_token")}var o=this.getTokenFromHash(window.location,this.opts.params);if(""!==o.token)return this.putInSession(o),void this.redirect();sessionStorage.setItem("oauth_redirect",window.location.href)}}return e.prototype.login=function(e){e&&sessionStorage.setItem("oauth_redirect",e),window.location.href=this.redirectURI()},e.prototype.logout=function(e){sessionStorage.removeItem("oauth_redirect"),sessionStorage.removeItem("oauth_token"),window.location.href=this.logoutURI(e)},e.prototype.redirectURI=function(){var e=encodeURIComponent(this.opts.redirectURI),t=Math.random().toString(36).substr(2,8),o=this.opts.scopes.join("%20");return this.opts.authURI+"?client_id="+this.opts.clientID+"&state="+t+"&scope="+o+"&response_type=token&redirect_uri="+e},e.prototype.logoutURI=function(e){var t;t=e?encodeURIComponent(e):encodeURIComponent(this.opts.redirectURI);return this.opts.logoutURI+"?redirect_uri="+t},e.prototype.token=function(){var e;e=this.getFromSession();var t=new Date(Date.now()-1e4);return e&&e.expires&&e.expires>t?new Promise(function(t,o){return t(e)}):(e&&e.expires&&e.expires<t&&(this._promise=null),this._promise||this.refresh(),this._promise)},e.prototype.redirect=function(){var e=sessionStorage.getItem("oauth_redirect");e&&(sessionStorage.removeItem("oauth_redirect"),window.location.href=e)},e.prototype.refresh=function(){var e=this;this._promise=this.iframe(this.opts),this._promise.then(function(t){e.putInSession(t)}).catch(function(e){})},e.prototype.defaults=function(e){return e.params||(e.params={}),e.params.token||(e.params.token="access_token"),e.params.expires||(e.params.expires="expires_in"),e.params.type||(e.params.type="token_type"),e.params.scope||(e.params.scope="scope"),e.authURI||console.error("Oauth2: the property authURI is missing"),e},e.prototype.iframe=function(e){var t=this;return new Promise(function(o,r){var n=document.createElement("iframe");n.setAttribute("src",t.redirectURI()),n.setAttribute("height","0"),n.setAttribute("width","0");var i=t.getTokenFromHash;n.onload=function(){var t=i(this.contentWindow.location,e.params);document.body.removeChild(n),""===t.token?r("token not found"):o(t)},n.onerror=function(e){r(e)},document.body.appendChild(n)})},e.prototype.getTokenFromHash=function(e,t){function o(e,t){for(var o=0;o<e.length;o++){var r=e[o].split("="),n=r[0],i=r[1];if(n===t)return i}return""}var r,n={token:"",scope:"",expires:new Date(0),type:""};try{r=e.hash.substring(1)}catch(e){return n}var i=r.split("&");n.token=o(i,t.token);var s=parseInt(o(i,t.expires));return n.expires=new Date(Date.now()+1e3*s),n.scope=o(i,t.scope),n.type=o(i,t.type),n},e.prototype.putInSession=function(e){if("object"==typeof e){var t=JSON.stringify(e);sessionStorage.setItem("oauth_token",t)}},e.prototype.getFromSession=function(){var e=sessionStorage.getItem("oauth_token");try{var t=JSON.parse(e);return t.expires=new Date(t.expires),t}catch(e){return null}},e.prototype.getCookie=function(e){var t=" "+document.cookie,o=t.indexOf(" "+e+"=");if(-1===o)t=null;else{o=t.indexOf("=",o)+1;var r=t.indexOf(";",o);-1===r&&(r=t.length),t=decodeURI(t.substring(o,r))}return t},e}();